const PRESETS=[{id:"playwright",name:"Playwright MCP",description:"瀏覽器自動化工具，可用於網頁測試和互動",config:{type:"stdio",command:"npx",args:["@playwright/mcp@latest","--allowed-hosts","*"],tools:["*"]}},{id:"brave-search",name:"Brave Search MCP",description:"網路搜尋功能，使用 Brave Search API",config:{type:"stdio",command:"npx",args:["-y","@modelcontextprotocol/server-brave-search"],env:{BRAVE_API_KEY:"<YOUR_API_KEY>"},tools:["*"]}},{id:"puppeteer",name:"Puppeteer MCP",description:"另一個瀏覽器自動化工具，基於 Chrome",config:{type:"stdio",command:"npx",args:["-y","@modelcontextprotocol/server-puppeteer"],tools:["*"]}},{id:"sqlite",name:"SQLite MCP",description:"SQLite 資料庫操作",config:{type:"stdio",command:"npx",args:["-y","@modelcontextprotocol/server-sqlite","/path/to/database.db"],tools:["*"]}},{id:"sequential-thinking",name:"Sequential Thinking MCP",description:"增強推理能力，支援複雜思考過程",config:{type:"stdio",command:"npx",args:["-y","@modelcontextprotocol/server-sequential-thinking"],tools:["*"]}},{id:"memory",name:"Memory MCP",description:"持久化記憶，跨對話保存資訊",config:{type:"stdio",command:"npx",args:["-y","@modelcontextprotocol/server-memory"],tools:["*"]}}];let selectedPresets=new Set,customConfigs=[],presetOverrides={},editingCustomId=null,editingPresetId=null;function escapeHtml(e){return e?e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;"):""}function init(){loadState(),renderPresets(),renderCustomConfigs(),updateJsonOutput()}function loadState(){const e=localStorage.getItem("mcpConfig");if(e)try{const t=JSON.parse(e);selectedPresets=new Set(t.selectedPresets||[]),customConfigs=t.customConfigs||[],presetOverrides=t.presetOverrides||{}}catch(e){console.error("Failed to load saved state:",e)}}function saveState(){const e={selectedPresets:Array.from(selectedPresets),customConfigs:customConfigs,presetOverrides:presetOverrides};localStorage.setItem("mcpConfig",JSON.stringify(e))}function renderPresets(){document.getElementById("presetList").innerHTML=PRESETS.map(e=>`\n                <div class="preset-item ${selectedPresets.has(e.id)?"selected":""}" id="preset-${e.id}">\n                    <div class="preset-header">\n                        <input type="checkbox" ${selectedPresets.has(e.id)?"checked":""} onclick="event.stopPropagation(); togglePreset('${e.id}')">\n                        <span class="preset-name" onclick="togglePreset('${e.id}')">${e.name}</span>\n                        <div class="preset-actions">\n                            <button class="small secondary" onclick="event.stopPropagation(); editPreset('${e.id}')">⚙️ 設定</button>\n                        </div>\n                    </div>\n                    <div class="preset-description">${e.description}</div>\n                </div>\n            `).join("")}function togglePreset(e){selectedPresets.has(e)?selectedPresets.delete(e):selectedPresets.add(e),saveState(),renderPresets(),updateJsonOutput()}function renderCustomConfigs(){const e=document.getElementById("customList");0!==customConfigs.length?e.innerHTML=customConfigs.map((e,t)=>`\n                <div class="custom-item">\n                    <div class="custom-item-info">\n                        <div class="custom-item-name">${escapeHtml(e.name)}</div>\n                        ${e.description?`<div style="font-size: 0.9em; color: #666;">${escapeHtml(e.description)}</div>`:""}\n                    </div>\n                    <div class="custom-item-actions">\n                        <button class="small secondary" onclick="editCustom(${t})">編輯</button>\n                        <button class="small danger" onclick="deleteCustom(${t})">刪除</button>\n                    </div>\n                </div>\n            `).join(""):e.innerHTML='<div class="empty-state">尚無自訂設定</div>'}function updateJsonOutput(){const e={};selectedPresets.forEach(t=>{const o=PRESETS.find(e=>e.id===t);if(o){const n=presetOverrides[t]||o.config;e[o.id]=n}}),customConfigs.forEach(t=>{e[t.name]=t.config});const t={mcpServers:e};document.getElementById("jsonOutput").value=JSON.stringify(t,null,2)}function stableStringify(e){if(null===e||"object"!=typeof e)return JSON.stringify(e);if(Array.isArray(e))return"["+e.map(stableStringify).join(",")+"]";return"{"+Object.keys(e).sort().map(t=>JSON.stringify(t)+":"+stableStringify(e[t])).join(",")+"}"}function applyStateFromJsonText(e){const t=JSON.parse(e);if(!t.mcpServers||"object"!=typeof t.mcpServers||Array.isArray(t.mcpServers))throw new Error("JSON 必須包含 mcpServers 物件");selectedPresets.clear(),presetOverrides={},customConfigs=[];for(const[e,o]of Object.entries(t.mcpServers)){const t=PRESETS.find(t=>t.id===e);t?(selectedPresets.add(e),stableStringify(o)!==stableStringify(t.config)&&(presetOverrides[e]=o)):customConfigs.push({name:e,description:"",config:o})}}function openAddCustomModal(){editingCustomId=null,editingPresetId=null,document.getElementById("modalTitle").textContent="新增自訂設定",document.getElementById("customForm").reset(),document.querySelector('input[name="connectionType"][value="stdio"]').checked=!0,updateConnectionTypeFields(),document.getElementById("customName").disabled=!1,document.getElementById("customDescription").disabled=!1,document.getElementById("customModal").classList.add("show")}function closeCustomModal(){document.getElementById("customModal").classList.remove("show"),editingCustomId=null,editingPresetId=null,document.getElementById("customName").disabled=!1,document.getElementById("customDescription").disabled=!1}function isCustomModalOpen(){return document.getElementById("customModal").classList.contains("show")}function saveCustomModal(){const e=document.getElementById("customForm");"function"!=typeof e.requestSubmit?e.dispatchEvent(new Event("submit",{bubbles:!0,cancelable:!0})):e.requestSubmit()}function updateConnectionTypeFields(){const e=document.querySelector('input[name="connectionType"]:checked').value;document.getElementById("stdioFields").style.display="stdio"===e?"block":"none",document.getElementById("httpFields").style.display="http"===e?"block":"none",document.getElementById("sseFields").style.display="sse"===e?"block":"none"}function editPreset(e){editingPresetId=e,editingCustomId=null;const t=PRESETS.find(t=>t.id===e);if(!t)return;const o=presetOverrides[e]||t.config;document.getElementById("modalTitle").textContent=`設定 ${t.name}`,document.getElementById("customName").value=t.id,document.getElementById("customName").disabled=!0,document.getElementById("customDescription").value=t.description,document.getElementById("customDescription").disabled=!0,loadConfigToForm(o),document.getElementById("customModal").classList.add("show")}function loadConfigToForm(e){const t=e.type||"stdio",o=document.querySelector(`input[name="connectionType"][value="${t}"]`);o&&(o.checked=!0),updateConnectionTypeFields(),"stdio"===t?(document.getElementById("stdioCommand").value=e.command||"",document.getElementById("stdioArgs").value=(e.args||[]).join("\n"),document.getElementById("stdioEnv").value=e.env?JSON.stringify(e.env,null,2):""):"http"===t?(document.getElementById("httpUrl").value=e.url||"",document.getElementById("httpHeaders").value=e.headers?JSON.stringify(e.headers,null,2):""):"sse"===t&&(document.getElementById("sseUrl").value=e.url||"",document.getElementById("sseHeaders").value=e.headers?JSON.stringify(e.headers,null,2):"");const n=e.tools;Array.isArray(n)&&1===n.length&&"*"===n[0]?document.getElementById("customTools").value='["*"]':Array.isArray(n)?document.getElementById("customTools").value=JSON.stringify(n):document.getElementById("customTools").value='["*"]'}function buildConfigFromForm(){const e=document.querySelector('input[name="connectionType"]:checked').value,t={type:e};try{if("stdio"===e){if(t.command=document.getElementById("stdioCommand").value.trim(),!t.command)throw new Error("命令欄位不可為空");const e=document.getElementById("stdioArgs").value.trim();t.args=e?e.split("\n").map(e=>e.trim()).filter(e=>e):[];const o=document.getElementById("stdioEnv").value.trim();o&&(t.env=JSON.parse(o))}else if("http"===e){if(t.url=document.getElementById("httpUrl").value.trim(),!t.url)throw new Error("URL 欄位不可為空");const e=document.getElementById("httpHeaders").value.trim();e&&(t.headers=JSON.parse(e))}else if("sse"===e){if(t.url=document.getElementById("sseUrl").value.trim(),!t.url)throw new Error("URL 欄位不可為空");const e=document.getElementById("sseHeaders").value.trim();e&&(t.headers=JSON.parse(e))}const o=document.getElementById("customTools").value.trim();if("*"===o)t.tools=["*"];else if(o.startsWith("[")){if(t.tools=JSON.parse(o),!Array.isArray(t.tools))throw new Error("工具欄位必須是陣列格式")}else t.tools=["*"]}catch(e){throw new Error(e.message.includes("JSON")?"JSON 格式錯誤："+e.message:e.message)}return t}function editCustom(e){editingCustomId=e,editingPresetId=null;const t=customConfigs[e];document.getElementById("modalTitle").textContent="編輯自訂設定",document.getElementById("customName").value=t.name,document.getElementById("customName").disabled=!1,document.getElementById("customDescription").value=t.description||"",document.getElementById("customDescription").disabled=!1,loadConfigToForm(t.config),document.getElementById("customModal").classList.add("show")}function deleteCustom(e){confirm("確定要刪除這個自訂設定嗎？")&&(customConfigs.splice(e,1),saveState(),renderCustomConfigs(),updateJsonOutput())}function copyToClipboard(){const e=document.getElementById("jsonOutput").value;navigator.clipboard&&window.isSecureContext?navigator.clipboard.writeText(e).catch(t=>{console.error("Failed to copy:",t),fallbackCopy(e)}):fallbackCopy(e)}function fallbackCopy(e){const t=document.createElement("textarea");t.value=e,t.style.position="fixed",t.style.left="-9999px",document.body.appendChild(t),t.select();try{document.execCommand("copy")}catch(e){console.error("Fallback copy failed:",e)}document.body.removeChild(t)}function exportConfig(){const e={selectedPresets:Array.from(selectedPresets),customConfigs:customConfigs},t=new Blob([JSON.stringify(e,null,2)],{type:"application/json"}),o=URL.createObjectURL(t),n=document.createElement("a");n.href=o,n.download="mcp-config.json",document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(o)}function importConfig(e){const t=e.target.files[0];if(!t)return;const o=new FileReader;o.onload=function(e){try{const t=JSON.parse(e.target.result);if("object"!=typeof t||null===t)throw new Error("無效的設定檔格式");if(t.selectedPresets&&!Array.isArray(t.selectedPresets))throw new Error("selectedPresets 必須是陣列");if(t.customConfigs&&!Array.isArray(t.customConfigs))throw new Error("customConfigs 必須是陣列");if(t.customConfigs)for(const e of t.customConfigs)if(!e.name||!e.config)throw new Error("自訂設定缺少必要欄位 (name 或 config)");selectedPresets=new Set(t.selectedPresets||[]),customConfigs=t.customConfigs||[],saveState(),renderPresets(),renderCustomConfigs(),updateJsonOutput(),alert("匯入成功！")}catch(e){let t="匯入失敗";e.message.includes("JSON")?t+="：檔案格式錯誤，請確認是有效的 JSON 檔案":t+="："+e.message,alert(t)}},o.readAsText(t),e.target.value=""}document.getElementById("customForm").addEventListener("submit",function(e){e.preventDefault();try{const e=buildConfigFromForm();if(null!==editingPresetId)presetOverrides[editingPresetId]=e,saveState(),updateJsonOutput(),closeCustomModal();else{const t=document.getElementById("customName").value.trim(),o={name:t,description:document.getElementById("customDescription").value.trim(),config:e};null!==editingCustomId?customConfigs[editingCustomId]=o:customConfigs.push(o),saveState(),renderCustomConfigs(),updateJsonOutput(),closeCustomModal()}document.getElementById("customName").disabled=!1,document.getElementById("customDescription").disabled=!1}catch(e){let t="設定錯誤";e.message.includes("JSON")?t+="：JSON 格式錯誤，請檢查 JSON 欄位的格式":t+="："+e.message,alert(t)}}),document.addEventListener("keydown",function(e){if(isCustomModalOpen()&&!e.isComposing)return"Escape"===e.key?(e.preventDefault(),void closeCustomModal()):void("Enter"!==e.key||!e.ctrlKey&&!e.metaKey||e.shiftKey||e.altKey||(e.preventDefault(),saveCustomModal()))}),document.getElementById("jsonOutput").addEventListener("input",function(){const e=this;try{applyStateFromJsonText(e.value),e.classList.remove("is-invalid"),saveState(),renderPresets(),renderCustomConfigs()}catch(t){e.classList.add("is-invalid")}}),init();